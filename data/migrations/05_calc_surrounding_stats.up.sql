-- SUPERMARKET
with temp AS (
SELECT hdb.TOWN, hdb.BLOCK, hdb.STREET_NAME,
smkt.DESCRIPTION, ST_DistanceSphere(hdb.geom, smkt.geom) AS DISTANCE
FROM api.tbl_hdb_addr_info hdb LEFT JOIN api.tbl_smkt_addr_info smkt
ON ST_DistanceSphere(hdb.geom, smkt.geom) <= 2000
)
SELECT * INTO api.TBL_STATS_HDB_SUPERMARKET FROM (
SELECT TOWN, BLOCK, STREET_NAME, DESCRIPTION AS MARKET_ID, DISTANCE AS MARKET_DIST,
SUM(CASE WHEN (DISTANCE > 1000) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MARKET_CNT_1KM_2KM,
SUM(CASE WHEN (DISTANCE <= 1000 AND DISTANCE > 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MARKET_CNT_500_1KM,
SUM(CASE WHEN (DISTANCE <= 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MARKET_CNT_WTH_500
FROM temp
ORDER BY TOWN, BLOCK, STREET_NAME, DISTANCE
) t;

-- SCHOOL
with temp AS (
SELECT t1.TOWN, t1.BLOCK, t1.STREET_NAME,
t2.SCHOOL_NAME, ST_DistanceSphere(t1.geom, t2.geom) AS DISTANCE
FROM api.tbl_hdb_addr_info t1 LEFT JOIN api.tbl_school_info t2
ON ST_DistanceSphere(t1.geom, t2.geom) <= 2000
AND t2.MAINLEVEL_CODE IN ('PRIMARY', 'MIXED LEVELS')
)
SELECT * INTO api.TBL_STATS_HDB_SCHOOL FROM (
SELECT TOWN, BLOCK, STREET_NAME, SCHOOL_NAME, DISTANCE AS SCHOOL_DIST,
SUM(CASE WHEN (DISTANCE > 1000) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS SCHOOL_CNT_1KM_2KM,
SUM(CASE WHEN (DISTANCE <= 1000 AND DISTANCE > 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS SCHOOL_CNT_500_1KM,
SUM(CASE WHEN (DISTANCE <= 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS SCHOOL_CNT_WTH_500
FROM temp
ORDER BY TOWN, BLOCK, STREET_NAME, DISTANCE
) t;

-- HAWKER CENTER
with temp AS (
SELECT t1.TOWN, t1.BLOCK, t1.STREET_NAME,
t2.NAME, ST_DistanceSphere(t1.geom, t2.geom) AS DISTANCE
FROM api.tbl_hdb_addr_info t1 LEFT JOIN api.tbl_hawker_addr_info t2
ON ST_DistanceSphere(t1.geom, t2.geom) <= 2000
)
SELECT * INTO api.TBL_STATS_HDB_HAWKER FROM (
SELECT TOWN, BLOCK, STREET_NAME, NAME AS HAWKER_NAME, DISTANCE AS HAWKER_DISTANCE,
SUM(CASE WHEN (DISTANCE > 1000) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS HAWKER_CNT_1KM_2KM,
SUM(CASE WHEN (DISTANCE <= 1000 AND DISTANCE > 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS HAWKER_CNT_500_1KM,
SUM(CASE WHEN (DISTANCE <= 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS HAWKER_CNT_WTH_500
FROM temp
ORDER BY TOWN, BLOCK, STREET_NAME, DISTANCE
) t;

-- MRT/LRT
with temp AS (
SELECT t1.TOWN, t1.BLOCK, t1.STREET_NAME,
t2.NAME, ST_DistanceSphere(t1.geom, t2.geom) AS DISTANCE
FROM api.tbl_hdb_addr_info t1 LEFT JOIN api.tbl_mrt_lrt_addr_info t2
ON ST_DistanceSphere(t1.geom, t2.geom) <= 2000
)
SELECT * INTO api.TBL_STATS_HDB_STATION FROM (
SELECT TOWN, BLOCK, STREET_NAME, NAME AS STATION_NAME, DISTANCE AS STATION_DISTANCE,
SUM(CASE WHEN (DISTANCE > 1000) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS STATION_CNT_1KM_2KM,
SUM(CASE WHEN (DISTANCE <= 1000 AND DISTANCE > 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS STATION_CNT_500_1KM,
SUM(CASE WHEN (DISTANCE <= 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS STATION_CNT_WTH_500
FROM temp
ORDER BY TOWN, BLOCK, STREET_NAME, DISTANCE
) t;

-- MALL
with temp AS (
SELECT t1.TOWN, t1.BLOCK, t1.STREET_NAME,
t2.NAME, ST_DistanceSphere(t1.geom, t2.geom) AS DISTANCE
FROM api.tbl_hdb_addr_info t1 LEFT JOIN api.tbl_mrt_lrt_addr_info t2
ON ST_DistanceSphere(t1.geom, t2.geom) <= 2000
)
SELECT * INTO api.TBL_STATS_HDB_MALL FROM (
SELECT TOWN, BLOCK, STREET_NAME, NAME AS MALL_NAME, DISTANCE AS MALL_DISTANCE,
SUM(CASE WHEN (DISTANCE > 1000) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MALL_CNT_1KM_2KM,
SUM(CASE WHEN (DISTANCE <= 1000 AND DISTANCE > 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MALL_CNT_500_1KM,
SUM(CASE WHEN (DISTANCE <= 500) THEN 1 ELSE 0 END) OVER (PARTITION BY TOWN, BLOCK, STREET_NAME) AS MALL_CNT_WTH_500
FROM temp
ORDER BY TOWN, BLOCK, STREET_NAME, DISTANCE
) t;

CREATE OR REPLACE VIEW api.VW_STATS_HDB_SURROUNDINGS AS (
	with t1 AS (
	SELECT DISTINCT TOWN, BLOCK, STREET_NAME, HAWKER_CNT_1KM_2KM, HAWKER_CNT_500_1KM, HAWKER_CNT_WTH_500 FROM api.tbl_stats_hdb_hawker
	),
	t2 AS (
	SELECT DISTINCT TOWN, BLOCK, STREET_NAME, SCHOOL_CNT_1KM_2KM, SCHOOL_CNT_500_1KM, SCHOOL_CNT_WTH_500 FROM api.tbl_stats_hdb_school
	),
	t3 AS (
	SELECT DISTINCT TOWN, BLOCK, STREET_NAME, STATION_CNT_1KM_2KM, STATION_CNT_500_1KM, STATION_CNT_WTH_500 FROM api.tbl_stats_hdb_station
	),
	t4 AS (
	SELECT DISTINCT TOWN, BLOCK, STREET_NAME, MARKET_CNT_1KM_2KM, MARKET_CNT_500_1KM, MARKET_CNT_WTH_500 FROM api.tbl_stats_hdb_supermarket
	),
	t5 AS (
	SELECT DISTINCT TOWN, BLOCK, STREET_NAME, MALL_CNT_1KM_2KM, MALL_CNT_500_1KM, MALL_CNT_WTH_500 FROM api.tbl_stats_hdb_mall
	)
	SELECT t1.*,
	SCHOOL_CNT_1KM_2KM, SCHOOL_CNT_500_1KM, SCHOOL_CNT_WTH_500,
	STATION_CNT_1KM_2KM, STATION_CNT_500_1KM, STATION_CNT_WTH_500,
	MARKET_CNT_1KM_2KM, MARKET_CNT_500_1KM, MARKET_CNT_WTH_500
	FROM t1
	LEFT JOIN t2 ON t1.TOWN = t2.TOWN AND t1.BLOCK = t2.BLOCK AND t1.STREET_NAME = t2.STREET_NAME
	LEFT JOIN t3 ON t1.TOWN = t3.TOWN AND t1.BLOCK = t3.BLOCK AND t1.STREET_NAME = t3.STREET_NAME
	LEFT JOIN t4 ON t1.TOWN = t4.TOWN AND t1.BLOCK = t4.BLOCK AND t1.STREET_NAME = t4.STREET_NAME
	LEFT JOIN t5 ON t1.TOWN = t5.TOWN AND t1.BLOCK = t5.BLOCK AND t1.STREET_NAME = t5.STREET_NAME
);
